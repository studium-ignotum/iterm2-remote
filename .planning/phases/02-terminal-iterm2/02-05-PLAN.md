---
phase: 02-terminal-iterm2
plan: 05
type: execute
wave: 3
depends_on: ["02-03", "02-04"]
files_modified:
  - src/lib/stores/tabs.svelte.ts
  - src/lib/components/TerminalTabs.svelte
  - src/lib/components/MobileControlBar.svelte
  - src/lib/stores/connection.ts
  - src/routes/+page.svelte
autonomous: false

must_haves:
  truths:
    - "User can see a list of iTerm2 tabs in the browser sidebar"
    - "User can click a tab to switch the active terminal session"
    - "Active tab is visually highlighted in the sidebar"
    - "Switching tabs in iTerm2 updates the browser tab selection"
    - "User can create a new tab from the browser"
    - "User can close a tab from the browser"
    - "New tabs appearing in iTerm2 automatically show in browser"
    - "Mobile users see a floating control bar with special keys (Esc, Ctrl, Tab, arrows)"
    - "Terminal and tabs layout is responsive for desktop and mobile"
  artifacts:
    - path: "src/lib/stores/tabs.svelte.ts"
      provides: "Tab state management with Svelte 5 runes"
      exports: ["tabsStore"]
    - path: "src/lib/components/TerminalTabs.svelte"
      provides: "Tab sidebar component matching iTerm2 layout"
      min_lines: 60
    - path: "src/lib/components/MobileControlBar.svelte"
      provides: "Floating special keys bar for mobile devices"
      min_lines: 40
  key_links:
    - from: "src/lib/stores/tabs.svelte.ts"
      to: "src/lib/stores/terminal.svelte.ts"
      via: "tab switch updates active terminal session"
      pattern: "terminalStore.setActiveSession"
    - from: "src/lib/stores/connection.ts"
      to: "src/lib/stores/tabs.svelte.ts"
      via: "tab_list and tab_switch messages update tab store"
      pattern: "tabsStore|tab_list|tab_switch"
    - from: "src/lib/components/TerminalTabs.svelte"
      to: "src/lib/stores/tabs.svelte.ts"
      via: "reads tab list, dispatches switch/create/close"
      pattern: "tabsStore"
    - from: "src/routes/+page.svelte"
      to: "src/lib/components/TerminalTabs.svelte"
      via: "renders sidebar alongside terminal"
      pattern: "TerminalTabs"
---

<objective>
Create the tab management sidebar and mobile control bar. The sidebar displays iTerm2 tabs with bidirectional switching, creation, and closing. The mobile control bar provides floating special keys for touch devices.

Purpose: Without tab management, users can only see one terminal session. The tab sidebar mirrors iTerm2's tab layout so users can navigate between sessions. The mobile control bar makes the terminal usable on phones and tablets where special keys (Esc, Ctrl, arrows) aren't available on virtual keyboards.

Output: Tab state store, TerminalTabs sidebar component, MobileControlBar component, updated main page layout, and wired connection store for tab messages.
</objective>

<execution_context>
@/Users/nat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-terminal-iterm2/02-RESEARCH.md
@.planning/phases/02-terminal-iterm2/02-CONTEXT.md
@.planning/phases/02-terminal-iterm2/02-03-SUMMARY.md
@.planning/phases/02-terminal-iterm2/02-04-SUMMARY.md

# Existing files to modify:
@src/lib/stores/connection.ts
@src/lib/stores/terminal.svelte.ts
@src/routes/+page.svelte
@src/shared/protocol.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tabs store and TerminalTabs sidebar component</name>
  <files>
    src/lib/stores/tabs.svelte.ts
    src/lib/components/TerminalTabs.svelte
    src/lib/stores/connection.ts
  </files>
  <action>
1. Create src/lib/stores/tabs.svelte.ts — tab state with Svelte 5 runes:

   ```typescript
   import { terminalStore } from './terminal.svelte';
   import { sendMessage } from './connection';

   interface TabInfo {
     tabId: string;
     sessionId: string;
     title: string;
     isActive: boolean;
   }

   let tabs = $state<TabInfo[]>([]);
   let activeTabId = $state<string | null>(null);

   export const tabsStore = {
     get tabs() { return tabs; },
     get activeTabId() { return activeTabId; },
     get activeTab() { return tabs.find(t => t.tabId === activeTabId) ?? null; },

     /**
      * Update the full tab list (from tab_list message).
      * Also sets active session in terminal store.
      */
     setTabs(newTabs: TabInfo[]) {
       tabs = newTabs;
       // Find the active tab and set it
       const active = newTabs.find(t => t.isActive);
       if (active) {
         activeTabId = active.tabId;
         terminalStore.setActiveSession(active.sessionId);
       } else if (newTabs.length > 0 && !activeTabId) {
         // If no active tab specified, default to first
         activeTabId = newTabs[0].tabId;
         terminalStore.setActiveSession(newTabs[0].sessionId);
       }
     },

     /**
      * Handle tab_switch message (from iTerm2 switching tabs).
      */
     handleTabSwitch(tabId: string) {
       activeTabId = tabId;
       const tab = tabs.find(t => t.tabId === tabId);
       if (tab) {
         // Update isActive flags
         tabs = tabs.map(t => ({ ...t, isActive: t.tabId === tabId }));
         terminalStore.setActiveSession(tab.sessionId);
       }
     },

     /**
      * Handle tab_created message.
      */
     handleTabCreated(tab: TabInfo) {
       tabs = [...tabs, tab];
     },

     /**
      * Handle tab_closed message.
      */
     handleTabClosed(tabId: string) {
       tabs = tabs.filter(t => t.tabId !== tabId);
       // If the closed tab was active, switch to first remaining
       if (activeTabId === tabId && tabs.length > 0) {
         activeTabId = tabs[0].tabId;
         terminalStore.setActiveSession(tabs[0].sessionId);
       }
     },

     /**
      * User clicks a tab in the sidebar — switch to it.
      * Sends message to Mac to also switch iTerm2's focus.
      */
     switchTab(tabId: string) {
       activeTabId = tabId;
       const tab = tabs.find(t => t.tabId === tabId);
       if (tab) {
         tabs = tabs.map(t => ({ ...t, isActive: t.tabId === tabId }));
         terminalStore.setActiveSession(tab.sessionId);
         // Tell Mac client to switch iTerm2's focus too (bidirectional sync)
         sendMessage({ type: 'tab_switch', tabId });
       }
     },

     /**
      * User requests a new tab from the browser.
      */
     createTab() {
       sendMessage({ type: 'tab_create' });
     },

     /**
      * User requests to close a tab from the browser.
      */
     closeTab(tabId: string) {
       sendMessage({ type: 'tab_close', tabId });
     },

     /**
      * Reset tab state (on disconnect).
      */
     reset() {
       tabs = [];
       activeTabId = null;
     },
   };
   ```

2. Update src/lib/stores/connection.ts to wire tab messages to the tabs store:
   - Import tabsStore: `import { tabsStore } from './tabs.svelte';`
   - Replace the placeholder tab message cases from Plan 02-04 with actual handling:
     ```typescript
     case 'tab_list': {
       tabsStore.setTabs(data.tabs);
       break;
     }
     case 'tab_switch': {
       tabsStore.handleTabSwitch(data.tabId);
       break;
     }
     case 'tab_created': {
       tabsStore.handleTabCreated(data.tab);
       break;
     }
     case 'tab_closed': {
       tabsStore.handleTabClosed(data.tabId);
       break;
     }
     ```
   - In the disconnect() function, add: `tabsStore.reset();`

3. Create src/lib/components/TerminalTabs.svelte — tab sidebar:

   ```svelte
   <script lang="ts">
     import { tabsStore } from '$lib/stores/tabs.svelte';

     function handleTabClick(tabId: string) {
       tabsStore.switchTab(tabId);
     }

     function handleNewTab() {
       tabsStore.createTab();
     }

     function handleCloseTab(e: MouseEvent, tabId: string) {
       e.stopPropagation(); // Don't trigger tab switch
       tabsStore.closeTab(tabId);
     }
   </script>

   <aside class="tab-sidebar">
     <div class="tab-header">
       <span class="tab-header-title">Tabs</span>
       <button class="new-tab-btn" onclick={handleNewTab} title="New Tab">+</button>
     </div>

     <div class="tab-list">
       {#each tabsStore.tabs as tab (tab.tabId)}
         <button
           class="tab-item"
           class:active={tab.tabId === tabsStore.activeTabId}
           onclick={() => handleTabClick(tab.tabId)}
         >
           <span class="tab-title">{tab.title}</span>
           <button
             class="close-tab-btn"
             onclick={(e) => handleCloseTab(e, tab.tabId)}
             title="Close Tab"
           >x</button>
         </button>
       {/each}
     </div>

     {#if tabsStore.tabs.length === 0}
       <div class="no-tabs">No tabs available</div>
     {/if}
   </aside>

   <style>
     .tab-sidebar {
       width: 200px;
       min-width: 150px;
       background: var(--bg-secondary, #1a1a2e);
       border-right: 1px solid var(--border, #333);
       display: flex;
       flex-direction: column;
       overflow-y: auto;
     }

     .tab-header {
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 8px 12px;
       border-bottom: 1px solid var(--border, #333);
     }

     .tab-header-title {
       font-size: 12px;
       font-weight: 600;
       text-transform: uppercase;
       letter-spacing: 0.5px;
       color: var(--text-muted, #888);
     }

     .new-tab-btn {
       background: none;
       border: 1px solid var(--border, #333);
       color: var(--text-muted, #888);
       width: 24px;
       height: 24px;
       border-radius: 4px;
       cursor: pointer;
       display: flex;
       align-items: center;
       justify-content: center;
       font-size: 16px;
       line-height: 1;
       padding: 0;
     }

     .new-tab-btn:hover {
       background: var(--bg-hover, #2a2a4a);
       color: var(--text-primary, #eee);
     }

     .tab-list {
       flex: 1;
       display: flex;
       flex-direction: column;
       padding: 4px;
       gap: 2px;
     }

     .tab-item {
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 8px 12px;
       background: none;
       border: none;
       border-radius: 4px;
       color: var(--text-secondary, #ccc);
       cursor: pointer;
       text-align: left;
       font-size: 13px;
       width: 100%;
     }

     .tab-item:hover {
       background: var(--bg-hover, #2a2a4a);
     }

     .tab-item.active {
       background: var(--bg-active, #3a3a5a);
       color: var(--text-primary, #fff);
       font-weight: 500;
     }

     .tab-title {
       overflow: hidden;
       text-overflow: ellipsis;
       white-space: nowrap;
       flex: 1;
     }

     .close-tab-btn {
       background: none;
       border: none;
       color: var(--text-muted, #666);
       cursor: pointer;
       padding: 2px 4px;
       font-size: 11px;
       border-radius: 2px;
       opacity: 0;
       transition: opacity 0.15s;
     }

     .tab-item:hover .close-tab-btn {
       opacity: 1;
     }

     .close-tab-btn:hover {
       background: var(--bg-hover, #444);
       color: var(--text-primary, #fff);
     }

     .no-tabs {
       padding: 12px;
       color: var(--text-muted, #666);
       font-size: 13px;
       text-align: center;
     }

     /* Mobile: hide sidebar, show as drawer or bottom sheet */
     @media (max-width: 768px) {
       .tab-sidebar {
         display: none;
       }
     }
   </style>
   ```
  </action>
  <verify>
    `cd /Users/nat/Desktop/claude-code-remote && pnpm check` passes.
    Verify tabs.svelte.ts exports tabsStore with tabs, activeTabId, switchTab, createTab, closeTab.
    Verify connection.ts routes tab messages to tabsStore.
    Verify TerminalTabs.svelte renders tab list and handles click/create/close.
  </verify>
  <done>
    Tab store manages tab list, active tab, and bidirectional sync. TerminalTabs sidebar shows tabs with switch/create/close. Connection store routes tab messages to store. Sidebar hides on mobile (<768px).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MobileControlBar and assemble main page layout</name>
  <files>
    src/lib/components/MobileControlBar.svelte
    src/routes/+page.svelte
  </files>
  <action>
1. Create src/lib/components/MobileControlBar.svelte — floating special keys:

   Follows the Termux/Blink Shell pattern from research:
   - Row of special key buttons above the virtual keyboard
   - Sticky modifier behavior (Ctrl tap highlights, applies to next key)
   - Visible only on touch devices or narrow screens

   ```svelte
   <script lang="ts">
     let { onKey } = $props<{
       onKey: (data: string) => void;
     }>();

     let ctrlActive = $state(false);
     let altActive = $state(false);

     // Special key sequences
     const keys = [
       { label: 'Esc', data: '\x1b' },
       { label: 'Tab', data: '\t' },
       { label: 'Ctrl', modifier: 'ctrl' },
       { label: 'Alt', modifier: 'alt' },
       { label: '|', data: '|' },
       { label: '~', data: '~' },
       // Arrow keys using ANSI escape sequences
       { label: '\u2191', data: '\x1b[A' },  // Up arrow
       { label: '\u2193', data: '\x1b[B' },  // Down arrow
       { label: '\u2190', data: '\x1b[D' },  // Left arrow
       { label: '\u2192', data: '\x1b[C' },  // Right arrow
     ];

     function handleKey(key: typeof keys[number]) {
       if (key.modifier === 'ctrl') {
         ctrlActive = !ctrlActive;
         altActive = false;
         return;
       }
       if (key.modifier === 'alt') {
         altActive = !altActive;
         ctrlActive = false;
         return;
       }

       let data = key.data!;

       // Apply Ctrl modifier: Ctrl+letter sends char code 1-26
       if (ctrlActive && data.length === 1) {
         const code = data.toUpperCase().charCodeAt(0);
         if (code >= 65 && code <= 90) {
           data = String.fromCharCode(code - 64);
         }
         ctrlActive = false;
       }

       // Apply Alt modifier: Alt sends ESC prefix
       if (altActive) {
         data = '\x1b' + data;
         altActive = false;
       }

       onKey(data);
     }
   </script>

   <div class="mobile-control-bar">
     {#each keys as key}
       <button
         class="control-key"
         class:active={
           (key.modifier === 'ctrl' && ctrlActive) ||
           (key.modifier === 'alt' && altActive)
         }
         onclick={() => handleKey(key)}
       >
         {key.label}
       </button>
     {/each}
   </div>

   <style>
     .mobile-control-bar {
       display: none;
       background: var(--bg-secondary, #1a1a2e);
       border-top: 1px solid var(--border, #333);
       padding: 4px;
       gap: 4px;
       overflow-x: auto;
       -webkit-overflow-scrolling: touch;
     }

     /* Show only on touch devices / narrow screens */
     @media (max-width: 768px), (pointer: coarse) {
       .mobile-control-bar {
         display: flex;
       }
     }

     .control-key {
       flex: 0 0 auto;
       min-width: 36px;
       height: 32px;
       padding: 4px 8px;
       background: var(--bg-tertiary, #2a2a4a);
       border: 1px solid var(--border, #444);
       border-radius: 4px;
       color: var(--text-secondary, #ccc);
       font-size: 13px;
       font-family: monospace;
       cursor: pointer;
       display: flex;
       align-items: center;
       justify-content: center;
       user-select: none;
       -webkit-user-select: none;
       touch-action: manipulation;
     }

     .control-key:active {
       background: var(--bg-active, #3a3a5a);
     }

     .control-key.active {
       background: var(--accent, #00d9ff);
       color: var(--bg-primary, #0f0f1a);
       border-color: var(--accent, #00d9ff);
     }
   </style>
   ```

2. Update src/routes/+page.svelte to assemble the full layout:
   - Import TerminalTabs, Terminal, MobileControlBar, ConnectionStatus
   - Import tabsStore, terminalStore, connectionStore, sendMessage
   - Layout: sidebar (tabs) + main area (terminal + mobile bar)
   - Handle terminal input/resize
   - Show appropriate state: login redirect, waiting for session, terminal view

   ```svelte
   <script lang="ts">
     import { goto } from '$app/navigation';
     import Terminal from '$lib/components/Terminal.svelte';
     import TerminalTabs from '$lib/components/TerminalTabs.svelte';
     import MobileControlBar from '$lib/components/MobileControlBar.svelte';
     import ConnectionStatus from '$lib/components/ConnectionStatus.svelte';
     import { connectionStore, disconnect, sendMessage } from '$lib/stores/connection';
     import { terminalStore } from '$lib/stores/terminal.svelte';
     import { tabsStore } from '$lib/stores/tabs.svelte';

     // Redirect to login if disconnected
     $effect(() => {
       if (connectionStore.state === 'disconnected') {
         goto('/login');
       }
     });

     function handleInput(data: string) {
       const sessionId = terminalStore.activeSessionId;
       if (sessionId) {
         sendMessage({
           type: 'terminal_input',
           sessionId,
           payload: data,
         });
       }
     }

     function handleResize(cols: number, rows: number) {
       const sessionId = terminalStore.activeSessionId;
       if (sessionId) {
         sendMessage({
           type: 'terminal_resize',
           sessionId,
           cols,
           rows,
         });
       }
     }

     function handleMobileKey(data: string) {
       handleInput(data);
     }

     function handleDisconnect() {
       disconnect();
     }
   </script>

   <div class="app-layout">
     <header class="app-header">
       <ConnectionStatus />
       <button class="disconnect-btn" onclick={handleDisconnect}>Disconnect</button>
     </header>

     {#if connectionStore.isConnected}
       <div class="main-content">
         <TerminalTabs />

         <div class="terminal-area">
           {#if terminalStore.activeSessionId}
             <Terminal
               sessionId={terminalStore.activeSessionId}
               options={terminalStore.options}
               onInput={handleInput}
               onResize={handleResize}
             />
           {:else}
             <div class="waiting">
               <p>Waiting for terminal sessions...</p>
               <p class="hint">Make sure iTerm2 is open with at least one tab.</p>
             </div>
           {/if}

           <MobileControlBar onKey={handleMobileKey} />
         </div>
       </div>
     {:else}
       <div class="connecting">
         <p>Connecting...</p>
       </div>
     {/if}
   </div>

   <style>
     .app-layout {
       height: 100vh;
       display: flex;
       flex-direction: column;
       background: var(--bg-primary, #0f0f1a);
       color: var(--text-primary, #eee);
     }

     .app-header {
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 4px 12px;
       background: var(--bg-secondary, #1a1a2e);
       border-bottom: 1px solid var(--border, #333);
       flex-shrink: 0;
     }

     .disconnect-btn {
       background: none;
       border: 1px solid var(--border, #444);
       color: var(--text-muted, #888);
       padding: 4px 12px;
       border-radius: 4px;
       cursor: pointer;
       font-size: 12px;
     }

     .disconnect-btn:hover {
       color: var(--text-primary, #eee);
       border-color: var(--text-muted, #888);
     }

     .main-content {
       flex: 1;
       display: flex;
       overflow: hidden;
     }

     .terminal-area {
       flex: 1;
       display: flex;
       flex-direction: column;
       overflow: hidden;
     }

     .waiting, .connecting {
       flex: 1;
       display: flex;
       flex-direction: column;
       align-items: center;
       justify-content: center;
       color: var(--text-muted, #888);
     }

     .hint {
       font-size: 13px;
       color: var(--text-muted, #666);
       margin-top: 8px;
     }

     /* Mobile: full width terminal, no sidebar */
     @media (max-width: 768px) {
       .main-content {
         flex-direction: column;
       }
     }
   </style>
   ```
  </action>
  <verify>
    `cd /Users/nat/Desktop/claude-code-remote && pnpm check` passes.
    `cd /Users/nat/Desktop/claude-code-remote && pnpm build` completes without errors.
    Verify +page.svelte renders TerminalTabs sidebar + Terminal + MobileControlBar.
    Verify MobileControlBar sends correct escape sequences for special keys.
  </verify>
  <done>
    Main page shows tab sidebar + terminal + mobile control bar. Tab switching, creation, and closing work bidirectionally. Mobile control bar provides Esc, Ctrl, Tab, arrow keys with sticky modifier support. Layout is responsive.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete terminal experience: iTerm2 sessions streaming to browser, keyboard input, tab management sidebar, mobile control bar, responsive resize, iTerm2 theme mirroring.
  </what-built>
  <how-to-verify>
    1. Ensure iTerm2 is open with 2+ tabs
    2. Enable iTerm2 Python API: Preferences > General > Magic > Enable Python API
    3. Install Python deps: `cd mac-client && pip3 install -r requirements.txt`
    4. Install socat if needed: `brew install socat`
    5. Start relay: `cd /Users/nat/Desktop/claude-code-remote && npx tsx src/relay/server.ts`
    6. Start Mac client: `cd mac-client && npx tsx src/index.ts`
    7. Start browser: `cd /Users/nat/Desktop/claude-code-remote && pnpm dev`
    8. Open browser at localhost:5173, enter session code

    Verify:
    - Terminal output appears in browser (try `ls`, `echo hello`)
    - Colors render correctly (try `ls --color`)
    - Typing in browser sends input to terminal
    - Tab sidebar shows iTerm2 tabs
    - Clicking a tab switches the terminal
    - Switching tab in iTerm2 updates browser
    - Creating a tab from browser creates it in iTerm2
    - Terminal resizes when you resize the browser window
    - Ctrl+C works (sends SIGINT, not copy)
    - On mobile (or narrow window): control bar appears with Esc/Ctrl/arrows
  </how-to-verify>
  <resume-signal>Type "approved" if terminal works correctly, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. Tab sidebar shows list of iTerm2 tabs with titles
2. Active tab is highlighted
3. Clicking a tab switches the terminal and notifies iTerm2
4. New tab button creates a tab in iTerm2
5. Close button removes tab from iTerm2 and browser
6. Mobile control bar provides Esc, Ctrl, Alt, Tab, arrows, pipe, tilde
7. Ctrl modifier is sticky (one tap highlights, applies to next key)
8. Layout is responsive: sidebar on desktop, hidden on mobile
9. Full terminal experience works end-to-end
</verification>

<success_criteria>
- Tab sidebar displays tabs from iTerm2 with correct titles
- Tab switching is bidirectional (browser ↔ iTerm2)
- Tab create/close from browser works
- New tabs in iTerm2 appear automatically in browser
- Mobile control bar sends correct terminal escape sequences
- Layout works on desktop (sidebar + terminal) and mobile (terminal + control bar)
- Complete Phase 2 success criteria met: real-time terminal with tabs
</success_criteria>

<output>
After completion, create `.planning/phases/02-terminal-iterm2/02-05-SUMMARY.md`
</output>
