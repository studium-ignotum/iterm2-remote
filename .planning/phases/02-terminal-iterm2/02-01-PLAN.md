---
phase: 02-terminal-iterm2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/protocol.ts
  - src/shared/constants.ts
  - src/relay/server.ts
autonomous: true

must_haves:
  truths:
    - "Terminal data messages with sessionId can be sent between Mac and browser"
    - "Tab management messages (list, switch, create, close) are routed through relay"
    - "Terminal resize messages propagate from browser to Mac"
    - "iTerm2 config messages flow from Mac to browser"
    - "Relay passes through all new message types without breaking existing auth flow"
  artifacts:
    - path: "src/shared/protocol.ts"
      provides: "Extended Zod schemas for terminal I/O, tab management, and config messages"
      exports: ["TerminalDataMessage", "TerminalInputMessage", "TerminalResizeMessage", "TabListMessage", "TabSwitchMessage", "TabCreateMessage", "TabCloseMessage", "TabCreatedMessage", "TabClosedMessage", "ConfigMessage", "TabInfo"]
    - path: "src/shared/constants.ts"
      provides: "Terminal-specific constants (resize debounce, min dimensions)"
      contains: "TERMINAL_RESIZE_DEBOUNCE_MS"
    - path: "src/relay/server.ts"
      provides: "Updated relay routing all new message types between paired connections"
      min_lines: 100
  key_links:
    - from: "src/relay/server.ts"
      to: "src/shared/protocol.ts"
      via: "message parsing includes new types"
      pattern: "TerminalDataMessage|TerminalInputMessage"
    - from: "src/relay/server.ts"
      to: "src/relay/session-registry.ts"
      via: "session lookup for routing"
      pattern: "findSessionByMac|joinedSession"
---

<objective>
Extend the WebSocket protocol with terminal I/O, tab management, and configuration message types, then update the relay server to route them between Mac and browser clients.

Purpose: All terminal data, tab operations, and config synchronization flow through the relay. Without these message types and routing, no terminal functionality can work.

Output: Extended protocol.ts with Zod schemas for all Phase 2 messages, updated relay server that routes them as passthrough between paired connections.
</objective>

<execution_context>
@/Users/nat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-terminal-iterm2/02-RESEARCH.md

# Existing files to extend (read these first):
@src/shared/protocol.ts
@src/shared/constants.ts
@src/relay/server.ts
@src/relay/session-registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend protocol schemas and constants for terminal/tab messages</name>
  <files>
    src/shared/protocol.ts
    src/shared/constants.ts
  </files>
  <action>
1. Add terminal constants to src/shared/constants.ts:
   - TERMINAL_RESIZE_DEBOUNCE_MS: 100
   - TERMINAL_MIN_COLS: 20
   - TERMINAL_MIN_ROWS: 5
   - TERMINAL_DEFAULT_SCROLLBACK: 10000

2. Extend src/shared/protocol.ts with new Zod schemas. Add AFTER existing message definitions but BEFORE the discriminated unions:

   Terminal I/O messages:
   - TerminalDataMessage: { type: 'terminal_data', sessionId: string, payload: string }
     Mac → Browser: raw terminal output (UTF-8 encoded escape sequences)
   - TerminalInputMessage: { type: 'terminal_input', sessionId: string, payload: string }
     Browser → Mac: user keystrokes
   - TerminalResizeMessage: { type: 'terminal_resize', sessionId: string, cols: z.number().int().positive(), rows: z.number().int().positive() }
     Browser → Mac: terminal dimensions changed

   Tab management messages:
   - TabInfo: z.object({ tabId: string, sessionId: string, title: string, isActive: boolean })
     Reusable schema for tab metadata
   - TabListMessage: { type: 'tab_list', tabs: z.array(TabInfo) }
     Mac → Browser: full tab list update
   - TabSwitchMessage: { type: 'tab_switch', tabId: string }
     Browser → Mac: request to switch active tab (bidirectional)
   - TabCreateMessage: { type: 'tab_create' }
     Browser → Mac: request to create new tab
   - TabCloseMessage: { type: 'tab_close', tabId: string }
     Browser → Mac: request to close tab
   - TabCreatedMessage: { type: 'tab_created', tab: TabInfo }
     Mac → Browser: new tab was created
   - TabClosedMessage: { type: 'tab_closed', tabId: string }
     Mac → Browser: tab was closed

   Config message:
   - ConfigMessage: { type: 'config', font: string, fontSize: number, cursorStyle: z.enum(['block', 'underline', 'bar']), cursorBlink: boolean, scrollback: number, theme: z.record(z.string()) }
     Mac → Browser: iTerm2 configuration for xterm.js

3. Update the IncomingMessage discriminated union to include ALL new message types that can be received by the relay (from either Mac or browser):
   Add: TerminalDataMessage, TerminalInputMessage, TerminalResizeMessage, TabListMessage, TabSwitchMessage, TabCreateMessage, TabCloseMessage, TabCreatedMessage, TabClosedMessage, ConfigMessage

4. Update the OutgoingMessage discriminated union similarly for completeness.

5. Export all new types (both Zod schemas and inferred TypeScript types).

IMPORTANT: Keep all existing message types unchanged. The new types ADD to the existing protocol, they don't replace anything.
  </action>
  <verify>
    Run `cd /Users/nat/Desktop/claude-code-remote && npx tsc --noEmit src/shared/protocol.ts src/shared/constants.ts` to verify compilation.
    Grep for all new exports to confirm they exist.
  </verify>
  <done>
    protocol.ts has Zod schemas for all terminal, tab, and config message types. constants.ts has terminal-specific constants. All types compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update relay server to route new message types</name>
  <files>
    src/relay/server.ts
  </files>
  <action>
Update src/relay/server.ts to route the new terminal and tab message types between paired connections.

The relay's role is PASSTHROUGH — it validates messages via Zod parsing (already happening) and forwards them to the paired connection. It does NOT interpret terminal data or tab operations.

1. In handleMacConnection, update the message switch statement:
   - Keep existing 'data', 'ping', 'register' cases unchanged
   - Add a case for each Mac→Browser message type: 'terminal_data', 'tab_list', 'tab_created', 'tab_closed', 'tab_switch', 'config'
   - For each: forward `raw` (the original JSON string) to `macSession.browser` if connected and OPEN
   - OR more cleanly: add a default case that checks if the Mac has a paired browser and forwards. This avoids listing every type. But ONLY forward for recognized types (the Zod parse already validates this).

   Recommended approach — replace the default error case with a passthrough:
   ```typescript
   default:
     // Forward any valid parsed message to paired browser
     const macSession = sessionRegistry.findSessionByMac(ws);
     if (macSession?.browser?.readyState === WebSocket.OPEN) {
       macSession.browser.send(raw);
     }
   ```

2. In handleBrowserConnection, update similarly:
   - Keep existing 'join', 'ping', 'register' cases unchanged
   - The existing 'data' case already forwards to Mac. Extend the default to forward all other valid message types to the paired Mac:
   ```typescript
   default:
     // Forward any valid parsed message to paired Mac
     if (state.joinedSession?.mac?.readyState === WebSocket.OPEN) {
       state.joinedSession.mac.send(raw);
     }
   ```

3. Remove the old default error responses for unrecognized message types. Since messages are Zod-validated, any message that reaches the switch is already a valid type. Unknown types are caught by the parser.

4. Verify: existing auth flow (register → registered, join → joined) still works. The passthrough default only applies to OTHER message types, not the ones with explicit cases.
  </action>
  <verify>
    Run `cd /Users/nat/Desktop/claude-code-remote && npx tsc --noEmit src/relay/server.ts` to verify compilation.
    Start the relay server and test: Mac connects, browser joins — existing flow unchanged.
    Send a terminal_data message from Mac side and verify it would route to browser (log check or wscat test).
  </verify>
  <done>
    Relay server routes all new terminal/tab/config message types between paired connections. Existing auth flow unchanged. Invalid messages still rejected by Zod parser.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for protocol.ts, constants.ts, and server.ts
2. All new Zod schemas export correctly (TerminalDataMessage, TabListMessage, etc.)
3. IncomingMessage union includes all new types
4. Relay server starts without errors
5. Existing register/join flow still works (not broken by changes)
6. Default passthrough forwards valid messages to paired connection
</verification>

<success_criteria>
- Protocol has Zod schemas for all 10 new message types
- Constants include terminal sizing/timing values
- Relay routes any valid message type between paired Mac/Browser connections
- Existing Phase 1 auth flow unaffected
- TypeScript strict compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-terminal-iterm2/02-01-SUMMARY.md`
</output>
