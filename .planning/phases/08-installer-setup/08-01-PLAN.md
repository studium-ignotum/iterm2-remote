---
phase: 08-installer-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/install.sh
  - scripts/uninstall.sh
autonomous: true

must_haves:
  truths:
    - "Running install.sh downloads and installs mac-client .app bundle, relay-server, cloudflared, tmux, and shell integration"
    - "Install fails immediately with clear message if Homebrew is not available"
    - "Re-running install.sh updates binaries without duplicating source lines in shell rc files"
    - "Running uninstall.sh removes all installed components, shell config lines, and LaunchAgent"
    - "After install, user can start Terminal Remote from installed location"
  artifacts:
    - path: "scripts/install.sh"
      provides: "Main curl|sh installer script"
      min_lines: 150
    - path: "scripts/uninstall.sh"
      provides: "Clean uninstall script"
      min_lines: 60
  key_links:
    - from: "scripts/install.sh"
      to: "GitHub Releases"
      via: "curl download of pre-built binaries"
      pattern: "github.com.*releases/download"
    - from: "scripts/install.sh"
      to: "~/.terminal-remote/"
      via: "file copy and directory creation"
      pattern: "INSTALL_DIR.*terminal-remote"
    - from: "scripts/install.sh"
      to: "shell rc files"
      via: "appending source line if not present"
      pattern: "source.*terminal-remote/init"
    - from: "scripts/uninstall.sh"
      to: "scripts/install.sh"
      via: "reverses all install actions"
      pattern: "rm.*terminal-remote"
---

<objective>
Create the main end-user installer (`curl -fsSL <url> | sh`) and a clean uninstall script for Terminal Remote on macOS.

Purpose: Enable single-command installation of the complete Terminal Remote stack -- mac-client menu bar app, relay-server, dependencies, and shell integration -- with idempotent re-run for updates and full uninstall capability.

Output: Two production-ready shell scripts (install.sh, uninstall.sh) that handle the complete lifecycle of a Terminal Remote installation.
</objective>

<execution_context>
@/Users/nat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-installer-setup/08-CONTEXT.md

# Key existing patterns to follow
@shell-integration/install.sh
@scripts/setup.sh
@scripts/start.sh
@mac-client/build-bundle.sh
@mac-client/Info.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create the main install script</name>
  <files>scripts/install.sh</files>
  <action>
Create `scripts/install.sh` -- the main curl|sh installer. This is the primary end-user onboarding script.

**Script structure (in order):**

1. **Header and constants:**
   - `#!/bin/bash` with `set -e`
   - Color codes matching existing scripts (RED, GREEN, YELLOW, BLUE, NC) -- see `scripts/setup.sh` for the pattern
   - `REPO="studium-ignotum/iterm2-remote"` (from git remote)
   - `VERSION="latest"` (can be overridden with `VERSION=v2.0.0 bash install.sh`)
   - `INSTALL_DIR="$HOME/.terminal-remote"`
   - `APP_DIR="$HOME/Applications"`
   - `APP_NAME="Terminal Remote.app"`
   - `LAUNCHAGENT_LABEL="com.terminal-remote.launcher"`
   - `LAUNCHAGENT_PLIST="$HOME/Library/LaunchAgents/${LAUNCHAGENT_LABEL}.plist"`

2. **Architecture detection:**
   - `ARCH=$(uname -m)` -- expects `arm64` or `x86_64`
   - If neither, print error and exit 1
   - Print detected architecture

3. **Homebrew check:**
   - If `command -v brew` fails, print error: "Homebrew is required to install dependencies (cloudflared, tmux)." with install link `https://brew.sh` and exit 1
   - This is a hard fail per user decision -- no partial installs

4. **Dependency installation:**
   - For each of `cloudflared` and `tmux`:
     - If `command -v $dep` succeeds, print "[checkmark] $dep already installed"
     - Else, print "Installing $dep..." and run `brew install $dep`
     - If brew install fails, print error and exit 1

5. **Resolve download URL:**
   - If `VERSION="latest"`, use GitHub API to resolve latest release tag:
     `curl -fsSL "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/'`
   - Construct download URL: `https://github.com/$REPO/releases/download/$VERSION/terminal-remote-$VERSION-darwin-$ARCH.tar.gz`
   - Download to temp directory: `TMPDIR=$(mktemp -d)`
   - `curl -fsSL -o "$TMPDIR/terminal-remote.tar.gz" "$DOWNLOAD_URL"`
   - If download fails, print clear error about release not found and exit 1
   - Extract: `tar -xzf "$TMPDIR/terminal-remote.tar.gz" -C "$TMPDIR"`

6. **Install binaries:**
   - Create directories: `mkdir -p "$INSTALL_DIR/bin"` and `mkdir -p "$APP_DIR"`
   - Install relay-server: `cp "$TMPDIR/relay-server" "$INSTALL_DIR/bin/relay-server"` then `chmod +x`
   - Install .app bundle: `rm -rf "$APP_DIR/$APP_NAME"` then `cp -R "$TMPDIR/$APP_NAME" "$APP_DIR/"`
   - Print installed paths

7. **Install shell integration:**
   - Copy init scripts from the archive (they should be included in the release tarball under a `shell-integration/` directory):
     `cp "$TMPDIR/shell-integration/init.zsh" "$INSTALL_DIR/"` (and init.bash, init.fish)
   - If the archive doesn't contain them, fall back to downloading from the repo:
     `curl -fsSL "https://raw.githubusercontent.com/$REPO/master/shell-integration/init.{zsh,bash,fish}" -o "$INSTALL_DIR/"`
   - Actually, to keep it simple and always up-to-date, download directly from the repo for shell scripts:
     ```
     for script in init.zsh init.bash init.fish; do
       curl -fsSL "https://raw.githubusercontent.com/$REPO/master/shell-integration/$script" -o "$INSTALL_DIR/$script"
     done
     ```

8. **Configure shell:**
   - Detect shell: `CURRENT_SHELL=$(basename "$SHELL")`
   - Determine rc file and init script based on shell:
     - `zsh` -> `~/.zshrc`, `init.zsh`
     - `bash` -> `~/.bashrc` (also check `~/.bash_profile` on macOS if `~/.bashrc` doesn't exist), `init.bash`
     - `fish` -> `~/.config/fish/config.fish`, `init.fish`
   - Build source line: `source "$INSTALL_DIR/init.$shell_ext"`
     - For fish: `source "$INSTALL_DIR/init.fish"` (fish uses same `source` command)
   - Check if source line already exists in rc file using `grep -qF`:
     - If present: print "Shell integration already configured in $RC_FILE"
     - If not present: append source line to END of rc file with a comment:
       ```
       echo "" >> "$RC_FILE"
       echo "# Terminal Remote shell integration" >> "$RC_FILE"
       echo "source \"$INSTALL_DIR/init.$SHELL_EXT\"" >> "$RC_FILE"
       ```
     - Print what was added and to which file

9. **Create launcher script:**
   - Create `$INSTALL_DIR/bin/terminal-remote-start`:
     ```bash
     #!/bin/bash
     # Terminal Remote launcher
     INSTALL_DIR="$HOME/.terminal-remote"
     APP_DIR="$HOME/Applications"

     # Start relay-server if not already running
     if ! pgrep -f "terminal-remote.*relay-server" > /dev/null 2>&1; then
       "$INSTALL_DIR/bin/relay-server" &
       sleep 0.5
     fi

     # Open the app (idempotent -- won't duplicate if already running)
     open "$APP_DIR/Terminal Remote.app"
     ```
   - `chmod +x "$INSTALL_DIR/bin/terminal-remote-start"`

10. **Login prompt:**
    - Print: "Start Terminal Remote at login? (y/n) "
    - Read user input (handle piped stdin: if not a terminal, default to "n")
    - If "y" or "Y":
      - Create `$LAUNCHAGENT_PLIST` with:
        ```xml
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" ...>
        <plist version="1.0">
        <dict>
          <key>Label</key>
          <string>com.terminal-remote.launcher</string>
          <key>ProgramArguments</key>
          <array>
            <string>$INSTALL_DIR/bin/terminal-remote-start</string>
          </array>
          <key>RunAtLoad</key>
          <true/>
          <key>KeepAlive</key>
          <false/>
        </dict>
        </plist>
        ```
      - `launchctl load "$LAUNCHAGENT_PLIST"` (load for current session too)
      - Print "Terminal Remote will start at login"
    - If "n": print "Skipped. You can start manually with: $INSTALL_DIR/bin/terminal-remote-start"

11. **Cleanup:**
    - `rm -rf "$TMPDIR"`

12. **Summary:**
    - Print a clear summary block (no emojis):
      ```
      ========================================
        Terminal Remote installed successfully
      ========================================

        Installed:
          App:               ~/Applications/Terminal Remote.app
          Relay server:      ~/.terminal-remote/bin/relay-server
          Shell integration: ~/.terminal-remote/init.{detected_shell}
          Dependencies:      cloudflared, tmux

        Get started:
          1. Start Terminal Remote:
             ~/.terminal-remote/bin/terminal-remote-start

          2. Look for the menu bar icon

          3. Copy the session code from the menu bar dropdown

          4. Open the tunnel URL on any device and enter the code

        Useful commands:
          Start:     ~/.terminal-remote/bin/terminal-remote-start
          Update:    curl -fsSL https://raw.githubusercontent.com/{REPO}/master/scripts/install.sh | sh
          Uninstall: curl -fsSL https://raw.githubusercontent.com/{REPO}/master/scripts/uninstall.sh | sh
      ```
    - Use color codes (GREEN for header, BLUE for paths, NC for reset)

**Idempotency requirements:**
- Binary installation: always overwrites (update case)
- Shell integration files: always overwrites (update case)
- Source line in rc file: only adds if not already present (grep -qF check)
- Deps: skips if already installed
- LaunchAgent: overwrites if exists
- Temp files: always cleaned up

**Error handling:**
- `set -e` for fail-fast
- Check each critical step (download, extract, copy) with explicit error messages
- Cleanup temp directory in a trap: `trap 'rm -rf "$TMPDIR"' EXIT`
  </action>
  <verify>
Run `bash -n scripts/install.sh` to verify syntax. Read the script and verify:
1. Homebrew check exits with code 1 and clear message if brew missing
2. Architecture detection handles arm64 and x86_64
3. Shell rc file modification uses grep -qF to prevent duplicate source lines
4. Temp directory cleanup is in a trap
5. Script is idempotent (re-running doesn't duplicate anything)
6. LaunchAgent plist has correct XML structure
  </verify>
  <done>
scripts/install.sh exists, passes bash syntax check, handles all installation steps (arch detection, Homebrew check, dep install, binary download, shell config, login prompt, summary), and is idempotent on re-run.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create the uninstall script</name>
  <files>scripts/uninstall.sh</files>
  <action>
Create `scripts/uninstall.sh` -- the clean removal script.

**Script structure:**

1. **Header:**
   - `#!/bin/bash` with `set -e`
   - Same color codes as install.sh
   - Same path constants: INSTALL_DIR, APP_DIR, APP_NAME, LAUNCHAGENT_PLIST

2. **Confirmation prompt:**
   - Print: "This will uninstall Terminal Remote and remove all configuration."
   - Print: "Continue? (y/n) "
   - If not "y"/"Y", print "Cancelled." and exit 0

3. **Stop running processes:**
   - `pkill -f "relay-server" 2>/dev/null || true`
   - `pkill -f "Terminal Remote" 2>/dev/null || true`
   - `pkill -f "mac-client" 2>/dev/null || true`

4. **Remove LaunchAgent:**
   - If `$LAUNCHAGENT_PLIST` exists:
     - `launchctl unload "$LAUNCHAGENT_PLIST" 2>/dev/null || true`
     - `rm -f "$LAUNCHAGENT_PLIST"`
     - Print "Removed login item"

5. **Remove .app bundle:**
   - `rm -rf "$APP_DIR/$APP_NAME"`
   - Print "Removed $APP_DIR/$APP_NAME"

6. **Remove shell integration source lines:**
   - For each shell config file (`~/.zshrc`, `~/.bashrc`, `~/.bash_profile`, `~/.config/fish/config.fish`):
     - If file exists AND contains a line matching `source.*terminal-remote/init`:
       - Use `sed -i '' '/# Terminal Remote shell integration/d'` to remove the comment line
       - Use `sed -i '' '/source.*terminal-remote\/init/d'` to remove the source line
       - Print "Removed source line from $file"
     - Handle both quoted and unquoted source line patterns

7. **Remove install directory:**
   - `rm -rf "$INSTALL_DIR"`
   - Print "Removed $INSTALL_DIR/"

8. **Optional dependency removal:**
   - Print: "Remove cloudflared and tmux? (y/n) "
   - If "y"/"Y":
     - `brew uninstall cloudflared 2>/dev/null || true`
     - `brew uninstall tmux 2>/dev/null || true`
     - Print "Removed cloudflared and tmux"
   - If "n": print "Kept cloudflared and tmux"

9. **Remove IPC socket:**
   - `rm -f /tmp/terminal-remote.sock`

10. **Summary:**
    ```
    ========================================
      Terminal Remote uninstalled
    ========================================

      Removed:
        - ~/Applications/Terminal Remote.app
        - ~/.terminal-remote/
        - Shell integration source lines
        - Login item (LaunchAgent)
        {if deps removed: - cloudflared, tmux}

      Your shell rc file(s) were modified. Restart your shell
      or open a new terminal window.
    ```
  </action>
  <verify>
Run `bash -n scripts/uninstall.sh` to verify syntax. Read the script and verify:
1. Confirmation prompt prevents accidental uninstall
2. sed commands correctly target source lines without damaging other rc file content
3. All installed paths from install.sh are covered (no orphaned files)
4. Optional dependency removal asks before removing
5. Handles missing files gracefully (no errors if already partially uninstalled)
  </verify>
  <done>
scripts/uninstall.sh exists, passes bash syntax check, removes all components installed by install.sh (app bundle, install dir, shell config lines, LaunchAgent, IPC socket), handles optional dep removal, and works gracefully when components are already missing.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/install.sh` exits 0 (valid syntax)
2. `bash -n scripts/uninstall.sh` exits 0 (valid syntax)
3. install.sh contains: architecture detection, Homebrew check, dependency install, binary download, shell config with duplicate prevention, LaunchAgent creation, idempotency logic, and post-install summary
4. uninstall.sh contains: confirmation prompt, process kill, LaunchAgent removal, app removal, shell line removal, install dir removal, optional dep removal
5. Both scripts use consistent path constants (INSTALL_DIR, APP_DIR, APP_NAME)
6. Both scripts follow the color code convention from existing scripts (setup.sh, start.sh)
</verification>

<success_criteria>
- scripts/install.sh handles the complete installation flow for Terminal Remote
- scripts/uninstall.sh cleanly reverses all install actions
- Both scripts pass bash syntax validation
- Install script is idempotent (safe to re-run for updates)
- Install script fails hard on missing Homebrew with clear error
- Uninstall script handles partial/missing installations gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/08-installer-setup/08-01-SUMMARY.md`
</output>
