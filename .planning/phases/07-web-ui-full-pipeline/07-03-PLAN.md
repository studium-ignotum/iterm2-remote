---
phase: 07-web-ui-full-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - relay-server/web-ui/vite.config.ts
  - relay-server/src/assets.rs
autonomous: false

must_haves:
  truths:
    - "pnpm build outputs to ../assets/ for relay embedding"
    - "Built assets work when served by Rust relay"
    - "End-to-end: browser can view and interact with connected terminal"
  artifacts:
    - path: "relay-server/web-ui/vite.config.ts"
      provides: "Vite build configuration"
      contains: "outDir: '../assets'"
    - path: "relay-server/src/assets.rs"
      provides: "Rust embed configuration"
      contains: "folder = \"assets\""
  key_links:
    - from: "vite.config.ts"
      to: "relay-server/assets/"
      via: "build output directory"
      pattern: "../assets"
    - from: "relay-server/src/assets.rs"
      to: "relay-server/assets/"
      via: "RustEmbed folder attribute"
      pattern: "folder = \"assets\""
---

<objective>
Configure Vite build for relay embedding and verify end-to-end functionality.

Purpose: Complete the integration by ensuring built assets are embedded in the Rust relay and the full terminal pipeline works.

Output:
- Vite build outputs to ../assets/ (relay embedding)
- End-to-end verification of complete pipeline
</objective>

<execution_context>
@/Users/nat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-web-ui-full-pipeline/07-RESEARCH.md
@.planning/phases/07-web-ui-full-pipeline/07-02-SUMMARY.md

Current vite config:
@relay-server/web-ui/vite.config.ts

Relay embeds assets from:
- relay-server/assets/ (rust-embed folder)

Phase context decision:
- "Build output goes directly to relay-server-v2/assets/"
- Since relay-server-v2 is deleted, use relay-server/assets/ instead
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Vite build configuration</name>
  <files>relay-server/web-ui/vite.config.ts</files>
  <action>
Update vite.config.ts for relay asset embedding:

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  build: {
    outDir: '../assets',      // Output to relay-server/assets/ for embedding
    emptyOutDir: true,        // Clean before build
    assetsDir: 'assets',      // Nest CSS/JS in assets/ subdirectory
  },
  server: {
    allowedHosts: true,
  },
});
```

Key changes:
- outDir: 'dist' -> '../assets' (parent directory relative to web-ui)
- Add emptyOutDir: true to clean old build artifacts
- Keep assetsDir: 'assets' for organized file structure
  </action>
  <verify>
1. Run build: `cd relay-server/web-ui && pnpm build`
2. Verify output in ../assets/: `ls -la relay-server/assets/`
3. Confirm index.html exists: `cat relay-server/assets/index.html | head -20`
  </verify>
  <done>pnpm build outputs to ../assets/ with index.html and asset files</done>
</task>

<task type="auto">
  <name>Task 2: Update Rust embed path to match Vite output</name>
  <files>relay-server/src/assets.rs</files>
  <action>
Update the RustEmbed folder attribute to point to the new build output location.

Change:
```rust
#[derive(RustEmbed, Clone)]
#[folder = "web-ui/dist"]
pub struct Assets;
```

To:
```rust
#[derive(RustEmbed, Clone)]
#[folder = "assets"]
pub struct Assets;
```

This aligns the Rust embed path with the Vite build output directory (relay-server/assets/).
  </action>
  <verify>
1. Verify the change: `grep -A1 "RustEmbed" relay-server/src/assets.rs`
2. Build relay: `cd relay-server && cargo build`
3. Confirm no errors related to missing assets folder
  </verify>
  <done>Rust embed points to "assets" folder, matching Vite build output</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete terminal pipeline: Rust relay with embedded web UI, mac-client with shell integration</what-built>
  <how-to-verify>
End-to-end verification steps:

**Prerequisites:**
1. Build web UI: `cd relay-server/web-ui && pnpm build`
2. Build and run relay: `cd relay-server && cargo run` (or use existing binary)
3. Run mac-client: `./mac-client` (or from Terminal Remote menu bar app)
4. Open a shell with integration: source ~/.terminal-remote/init.zsh (or start new terminal)

**Browser Test:**
1. Open browser to http://localhost:3000 (or relay URL)
2. Enter the session code shown in mac-client menu
3. Click Connect

**Verify these success criteria:**

WEB-01: Real-time terminal output streaming
- [ ] Terminal output appears in browser as you type in local shell

WEB-02: Keyboard input sent to terminal
- [ ] Type in browser terminal, input appears in local shell
- [ ] Ctrl+C works (interrupt a running command like `sleep 100`)
- [ ] Arrow keys work (command history, cursor movement)
- [ ] Tab completion works

WEB-03: Full terminal emulation
- [ ] Run `htop` or `vim` - TUI renders correctly
- [ ] Colors display properly (try `ls --color=auto`)
- [ ] Cursor positioning works in editors

WEB-04: Copy/paste support
- [ ] Select text in terminal, Cmd+C copies
- [ ] Cmd+V pastes into terminal

WEB-05: Connection status indicator
- [ ] Status shows "Connected" when connected
- [ ] Status updates on disconnect

WEB-06: Session code entry
- [ ] Login page accepts 6-character session code
- [ ] Invalid codes show error message

WEB-07: Terminal resizes with browser
- [ ] Resize browser window, terminal adjusts
- [ ] Run `tput cols; tput lines` before and after resize

WEB-08: Multi-session sidebar
- [ ] If multiple shells connected, they appear in sidebar
- [ ] (Open another terminal with shell integration to test)

WEB-09: Session switching
- [ ] Click different session in sidebar, terminal switches
- [ ] Previous session content preserved when switching back

**Known limitations (acceptable for initial release):**
- Session names may show as session ID until explicit session messages implemented
- Brief delay on session disconnect detection
  </how-to-verify>
  <resume-signal>Type "verified" with any issues found, or describe what doesn't work</resume-signal>
</task>

</tasks>

<verification>
1. Build completes without errors
2. Assets exist in relay-server/assets/
3. All WEB-* requirements verified manually
</verification>

<success_criteria>
- Vite builds to ../assets/ successfully
- Rust relay serves embedded web UI
- End-to-end terminal interaction works (see checkpoint for full list)
- All 9 WEB requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-ui-full-pipeline/07-03-SUMMARY.md`
</output>
