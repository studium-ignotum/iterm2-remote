---
phase: 05-mac-client
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mac-client/Cargo.toml
  - mac-client/src/main.rs
  - mac-client/src/lib.rs
  - mac-client/resources/icon.png
autonomous: true

must_haves:
  truths:
    - "App runs with tray icon visible in menu bar"
    - "Click icon shows dropdown menu with placeholder items"
    - "Quit menu item exits the application"
  artifacts:
    - path: "mac-client/Cargo.toml"
      provides: "Project configuration with all dependencies"
      contains: "tray-icon"
    - path: "mac-client/src/main.rs"
      provides: "Entry point with tray icon and event loop"
      min_lines: 80
    - path: "mac-client/resources/icon.png"
      provides: "Template image for menu bar"
  key_links:
    - from: "main.rs"
      to: "tray-icon"
      via: "TrayIconBuilder"
      pattern: "TrayIconBuilder::new"
    - from: "main.rs"
      to: "muda"
      via: "Menu construction"
      pattern: "Menu::new"
---

<objective>
Create the mac-client project foundation with tray icon and menu skeleton.

Purpose: Establish the project structure, threading architecture, and basic tray icon that all subsequent plans build upon. This plan creates a working menu bar app with placeholder content.

Output: A runnable menu bar app that shows an icon, displays a dropdown menu with dummy items, and can quit cleanly.
</objective>

<execution_context>
@/Users/nat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-mac-client/05-RESEARCH.md

# Reference relay server protocol for later integration
@relay-server-v2/src/protocol.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project structure and Cargo.toml</name>
  <files>mac-client/Cargo.toml, mac-client/src/lib.rs</files>
  <action>
Create mac-client directory alongside relay-server-v2.

Create Cargo.toml with all dependencies from research:
```toml
[package]
name = "mac-client"
version = "0.1.0"
edition = "2021"

[dependencies]
tray-icon = "0.21"
muda = "0.17"
image = "0.25"
tokio = { version = "1", features = ["full", "sync", "net"] }
tokio-tungstenite = { version = "0.28", features = ["native-tls"] }
futures-util = "0.3"
arboard = "3.6"
serde = { version = "1", features = ["derive"] }
serde_json = "1"
uuid = { version = "1", features = ["v4"] }
tracing = "0.1"
tracing-subscriber = "0.3"
```

Note: smappservice-rs will be added in Plan 05-05 (requires macOS 13+ testing).

Create lib.rs as module root (empty for now, will export modules in later plans).
  </action>
  <verify>
Run `cargo check --manifest-path mac-client/Cargo.toml` - should succeed with no errors (only warnings about unused dependencies are OK).
  </verify>
  <done>
Cargo.toml exists with all core dependencies, cargo check passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create template icon</name>
  <files>mac-client/resources/icon.png</files>
  <action>
Create resources directory: `mac-client/resources/`

Create a 22x22 PNG template icon for the menu bar:
- Black (#000000) on transparent background
- Simple terminal/console shape (rectangle with command prompt symbol)
- Single channel or grayscale is fine
- macOS will automatically invert for dark mode when icon_as_template(true) is used

Use a simple programmatic approach - create a minimal PNG with the `image` crate in a build script, OR embed a pre-made icon bytes.

For simplicity, create the icon programmatically in main.rs using the image crate:
- 22x22 RGBA image
- Draw a simple terminal rectangle shape
- Fill with black pixels on transparent background
- Pass directly to TrayIconBuilder without file I/O

Alternative: Use include_bytes! with a hand-crafted icon.png if available. A simple black square with rounded corners works as placeholder.

The key requirement is: black shapes on transparent background, 22x22 or 44x44 (2x for Retina).
  </action>
  <verify>
Icon file exists at mac-client/resources/icon.png OR icon is generated programmatically in main.rs. Either approach is valid.
  </verify>
  <done>
Template icon is available for tray icon builder.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create main.rs with tray icon and menu skeleton</name>
  <files>mac-client/src/main.rs</files>
  <action>
Create main.rs implementing the main thread + background thread architecture from research.

Structure:
1. Define channel message types (UiCommand, BackgroundCommand) for future use
2. Create tray icon with template image
3. Create menu with placeholder items matching CLIENT requirements:
   - Session code display (disabled text): "Code: ------"
   - Connection status (disabled text): "Status: Connecting..."
   - Session count (disabled text): "Sessions: 0"
   - Separator
   - Copy Session Code (enabled, with ID "copy_code")
   - Separator
   - Start at Login (checkbox, with ID "login_item") - non-functional placeholder
   - Separator
   - Quit (enabled, with ID "quit")

4. Main event loop:
   - Poll TrayIconEvent::receiver() with try_recv()
   - Poll MenuEvent::receiver() with try_recv()
   - Handle "quit" menu event by exiting
   - Handle "copy_code" menu event with placeholder (log message for now)
   - Small sleep (10ms) to avoid busy-waiting

5. Set up tracing subscriber for logging

Key patterns from research:
- TrayIconBuilder::new().with_menu(Box::new(menu.clone())).with_icon(icon).with_icon_as_template(true)
- Menu items: MenuItem::new(text, enabled, accelerator) for display-only
- Menu items: MenuItem::with_id(id, text, enabled, accelerator) for clickable
- PredefinedMenuItem::separator() for separators

Do NOT start background thread yet - that comes in integration plan.
  </action>
  <verify>
Run `cargo run --manifest-path mac-client/Cargo.toml`:
1. App starts without Dock icon flashing (may briefly appear since no Info.plist yet)
2. Tray icon appears in menu bar
3. Clicking icon shows dropdown menu with all items
4. Clicking Quit exits the app
5. Check console for any errors
  </verify>
  <done>
Menu bar app runs with visible tray icon, dropdown menu shows placeholder items, Quit works.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `cargo check --manifest-path mac-client/Cargo.toml` passes
2. `cargo run --manifest-path mac-client/Cargo.toml` shows tray icon in menu bar
3. Menu dropdown displays: Code, Status, Sessions, Copy, Login toggle, Quit
4. Quit menu item cleanly exits the app
</verification>

<success_criteria>
- mac-client project compiles with all dependencies
- Tray icon visible in menu bar
- Menu dropdown shows all placeholder items per CLIENT requirements
- Quit functionality works
- Code structure supports adding background tasks in future plans
</success_criteria>

<output>
After completion, create `.planning/phases/05-mac-client/05-01-SUMMARY.md`
</output>
