---
phase: 05-mac-client
plan: 05
type: execute
wave: 4
depends_on: ["05-04"]
files_modified:
  - mac-client/Info.plist
  - mac-client/Cargo.toml
  - mac-client/src/main.rs
  - mac-client/build.rs
autonomous: false

must_haves:
  truths:
    - "App runs with no Dock icon when launched from .app bundle"
    - "Start at Login toggle in menu registers/unregisters login item"
    - "Login item registration persists across app restarts"
  artifacts:
    - path: "mac-client/Info.plist"
      provides: "App bundle configuration with LSUIElement"
      contains: "LSUIElement"
    - path: "mac-client/src/main.rs"
      provides: "Login item toggle handler"
      contains: "login_item"
  key_links:
    - from: "main.rs"
      to: "smappservice"
      via: "login item registration"
      pattern: "register|unregister"
---

<objective>
Create app bundle configuration and implement login item functionality.

Purpose: Make the mac-client a proper macOS menu bar app that hides from the Dock and can optionally start at login. This completes CLIENT-01 (no Dock icon) and CLIENT-11 (start at login).

Output: A properly bundled .app that runs as a menu bar-only application with working login item toggle.
</objective>

<execution_context>
@/Users/nat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-mac-client/05-RESEARCH.md
@.planning/phases/05-mac-client/05-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Info.plist for app bundle</name>
  <files>mac-client/Info.plist</files>
  <action>
Create Info.plist in mac-client/ directory:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleIdentifier</key>
    <string>com.terminal-remote.mac-client</string>
    <key>CFBundleName</key>
    <string>Terminal Remote</string>
    <key>CFBundleDisplayName</key>
    <string>Terminal Remote</string>
    <key>CFBundleVersion</key>
    <string>2.0.0</string>
    <key>CFBundleShortVersionString</key>
    <string>2.0.0</string>
    <key>CFBundleExecutable</key>
    <string>mac-client</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>LSUIElement</key>
    <true/>
    <key>LSMinimumSystemVersion</key>
    <string>13.0</string>
    <key>NSHighResolutionCapable</key>
    <true/>
</dict>
</plist>
```

Key settings:
- **LSUIElement = true**: Hides app from Dock, makes it menu bar-only
- **LSMinimumSystemVersion = 13.0**: Required for SMAppService (login items)
- **CFBundleIdentifier**: Unique identifier for the app

Note: LSUIElement only takes effect when running from a proper .app bundle. During development with `cargo run`, the Dock icon may still briefly appear.
  </action>
  <verify>
File exists at mac-client/Info.plist with correct XML structure.
  </verify>
  <done>
Info.plist created with LSUIElement=true and proper bundle identifiers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create app bundle build script</name>
  <files>mac-client/build.rs, mac-client/Cargo.toml</files>
  <action>
Create a simple shell script or Makefile target to build the .app bundle structure.

For now, create a README section or script that documents the bundling process:

**Option A: Manual bundling (document in code comments):**
```bash
# Build release binary
cargo build --release --manifest-path mac-client/Cargo.toml

# Create .app structure
mkdir -p "Terminal Remote.app/Contents/MacOS"
mkdir -p "Terminal Remote.app/Contents/Resources"

# Copy binary
cp target/release/mac-client "Terminal Remote.app/Contents/MacOS/"

# Copy Info.plist
cp mac-client/Info.plist "Terminal Remote.app/Contents/"

# Copy icon (if we have an .icns file)
# cp mac-client/resources/AppIcon.icns "Terminal Remote.app/Contents/Resources/"
```

**Option B: cargo-bundle (add to Cargo.toml):**
```toml
[package.metadata.bundle]
name = "Terminal Remote"
identifier = "com.terminal-remote.mac-client"
icon = ["resources/icon.png"]
resources = []
```

Then run: `cargo bundle --release`

For this plan, document the manual approach in a comment block at the top of main.rs. Full build automation can come later.

Add a note in Cargo.toml:
```toml
# Build .app bundle:
# 1. cargo build --release
# 2. mkdir -p "Terminal Remote.app/Contents/MacOS"
# 3. cp target/release/mac-client "Terminal Remote.app/Contents/MacOS/"
# 4. cp mac-client/Info.plist "Terminal Remote.app/Contents/"
```
  </action>
  <verify>
Build and create bundle manually:
1. `cargo build --release --manifest-path mac-client/Cargo.toml`
2. Create .app structure as documented
3. Launch "Terminal Remote.app" from Finder
4. Verify NO Dock icon appears (only menu bar icon)
  </verify>
  <done>
Bundle creation process documented, .app bundle can be created manually.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement login item toggle (optional - may skip if smappservice issues)</name>
  <files>mac-client/Cargo.toml, mac-client/src/main.rs</files>
  <action>
Add smappservice-rs dependency to Cargo.toml:
```toml
smappservice-rs = "0.1"
```

Note: smappservice-rs requires macOS 13+ and the app must be properly signed and bundled for login item registration to work reliably. During development, this may fail or require System Settings approval.

**Implement login item handler in main.rs:**

1. Add a CheckMenuItem for login item toggle (instead of regular MenuItem):
   ```rust
   use muda::CheckMenuItem;

   let login_item = CheckMenuItem::with_id("login_item", "Start at Login", true, false, None);
   ```

2. Handle the toggle in menu event handler:
   ```rust
   "login_item" => {
       // Toggle the checkbox
       let current = login_item.is_checked();
       login_item.set_checked(!current);

       // Register/unregister login item
       if let Err(e) = configure_login_item(!current) {
           tracing::error!("Failed to configure login item: {}", e);
           // Revert checkbox on failure
           login_item.set_checked(current);
       }
   }
   ```

3. Create configure_login_item function:
   ```rust
   fn configure_login_item(enable: bool) -> Result<(), Box<dyn std::error::Error>> {
       use smappservice_rs::{AppService, ServiceType};

       let service = AppService::new(ServiceType::MainApp);

       if enable {
           service.register()?;
           tracing::info!("Registered as login item");
       } else {
           service.unregister()?;
           tracing::info!("Unregistered as login item");
       }

       Ok(())
   }
   ```

4. On startup, check current login item status and set checkbox accordingly:
   ```rust
   fn is_login_item_enabled() -> bool {
       use smappservice_rs::{AppService, ServiceType, ServiceStatus};
       let service = AppService::new(ServiceType::MainApp);
       matches!(service.status(), ServiceStatus::Enabled)
   }

   // In main():
   let is_enabled = is_login_item_enabled();
   login_item.set_checked(is_enabled);
   ```

**Fallback if smappservice-rs has issues:**
If the crate doesn't compile or work properly, make the menu item non-functional with a log message explaining it requires a signed .app bundle. Don't block the phase on this feature.
  </action>
  <verify>
1. Build and run from .app bundle
2. Toggle "Start at Login" in menu
3. Check System Settings > General > Login Items - app should appear/disappear
4. Restart Mac (or logout/login) - app should auto-start if enabled

If login item registration fails with permission errors, verify:
- App is properly bundled with Info.plist
- App may need to be in /Applications
- User may need to approve in System Settings
  </verify>
  <done>
Login item toggle works when running from proper .app bundle, or gracefully logs error if not available.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 5 Mac Client with:
- Menu bar icon with dropdown menu
- Real session code from relay server
- Connection status indicator
- Copy to clipboard functionality
- Unix socket listener for shell integration
- App bundle with no Dock icon
- Optional login item support
  </what-built>
  <how-to-verify>
1. **Start relay server:**
   ```bash
   cargo run --manifest-path relay-server-v2/Cargo.toml
   ```

2. **Build and run mac-client as .app bundle:**
   ```bash
   cargo build --release --manifest-path mac-client/Cargo.toml
   mkdir -p "Terminal Remote.app/Contents/MacOS"
   cp target/release/mac-client "Terminal Remote.app/Contents/MacOS/"
   cp mac-client/Info.plist "Terminal Remote.app/Contents/"
   open "Terminal Remote.app"
   ```

3. **Verify menu bar behavior:**
   - [ ] Tray icon appears in menu bar (near clock)
   - [ ] NO Dock icon visible
   - [ ] Click icon shows dropdown menu

4. **Verify menu contents:**
   - [ ] "Code: XXXXXX" shows 6-character code (not "------")
   - [ ] "Status: Connected" is displayed
   - [ ] "Sessions: 0" is displayed
   - [ ] "Copy Session Code" is clickable
   - [ ] "Start at Login" checkbox is present
   - [ ] "Quit" is clickable

5. **Verify functionality:**
   - [ ] Click "Copy Session Code" then Cmd+V somewhere - pastes the code
   - [ ] Stop relay server - status changes to "Disconnected"
   - [ ] Restart relay - auto-reconnects, gets new code
   - [ ] Unix socket exists: `ls -la /tmp/terminal-remote.sock`

6. **Verify quit:**
   - [ ] Click "Quit" - app exits
   - [ ] Socket file is cleaned up: `ls /tmp/terminal-remote.sock` should fail

7. **(Optional) Login item:**
   - [ ] Toggle "Start at Login"
   - [ ] Check System Settings > Login Items
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. App bundle runs with no Dock icon
2. All menu functionality works
3. WebSocket connection with auto-reconnect
4. Unix socket ready for Phase 6 shell integration
5. Human verification passes
</verification>

<success_criteria>
- CLIENT-01: App runs as menu bar app with no Dock icon (from .app bundle)
- CLIENT-02: WebSocket connection with auto-reconnect (verified)
- CLIENT-03: Unix socket listener exists at /tmp/terminal-remote.sock
- CLIENT-04: Session tracking infrastructure in place
- CLIENT-05: Status icon visible in menu bar
- CLIENT-06: Click icon opens dropdown menu
- CLIENT-07: Session code displayed in menu
- CLIENT-08: Copy session code to clipboard works
- CLIENT-09: Connection status indicator works
- CLIENT-10: Quit option works
- CLIENT-11: Start at login option available (may need approval)
- CLIENT-12: Template image adapts to dark/light mode
- CLIENT-13: Session count displayed in menu
</success_criteria>

<output>
After completion, create `.planning/phases/05-mac-client/05-05-SUMMARY.md`
</output>
